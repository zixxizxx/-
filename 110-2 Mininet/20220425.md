## SSH Tunnel

### Local Port Forwarding 
翻牆翻出來
* 拓撲圖

![image](https://github.com/zixxizxx/Liux-note/blob/main/110-2%20Mininet/image/20220425/0425-3.jpg)
* lab2.py
```
#!/usr/bin/python
from mininet.net import Containernet
from mininet.node import Docker
from mininet.cli import CLI
from mininet.log import setLogLevel, info
from mininet.link import TCLink, Link
 
def topology():
 
    "Create a network with some docker containers acting as hosts."
    net = Containernet()
 
    info('*** Adding hosts\n')
    h1 = net.addHost('h1', ip='192.168.0.1/24')
    d1 = net.addDocker('d1', ip='192.168.0.2/24', dimage="ubuntu:1.0")
    d2 = net.addDocker('d2', ip='192.168.0.3/24', dimage="ubuntu:1.0")
    br1 = net.addHost('br1')
 
    info('*** Creating links\n')
    net.addLink(h1, br1)
    net.addLink(d1, br1)
    net.addLink(d2, br1)
   
    info('*** Starting network\n')
    net.start()
    d1.cmd("/etc/init.d/ssh start")
    d2.cmd("/etc/init.d/apache2 start")
    d2.cmd("iptables -A INPUT -s 192.168.0.1 -j DROP")
    br1.cmd("ifconfig br1-eth0 0")
    br1.cmd("ifconfig br1-eth1 0")
    br1.cmd("ifconfig br1-eth2 0")
    br1.cmd("brctl addbr br1")
    br1.cmd("brctl addif br1 br1-eth0")
    br1.cmd("brctl addif br1 br1-eth1")
    br1.cmd("brctl addif br1 br1-eth2")
    br1.cmd("ifconfig br1 up") 
 
    info('*** Running CLI\n')
    CLI(net)
 
    info('*** Stopping network')
    net.stop()
 
if __name__ == '__main__':
    setLogLevel('info')
    topology()

```
執行檔案
```
# python3 lab2.py
 > xterm h1 
 > d2 ifconfig
 
```

在h1建立加密登入
```
//抓不到
# curl 192.168.0.3 

# ssh -Nf -L 5555:192.168.0.3:80 root@192.168.0.2
  passwd：ubuntu
# curl 127.0.0.1:5555
# firefox
```
firefox search 127.0.0.1:5555
![image](https://github.com/zixxizxx/Liux-note/blob/main/110-2%20Mininet/image/20220425/0425-1.jpg)

### Remote Port Forwarding
翻牆翻進去
* 拓撲圖

![image](https://github.com/zixxizxx/Liux-note/blob/main/110-2%20Mininet/image/20220425/0425-4.jpg)

* lab3.py
```
#!/usr/bin/python
from mininet.net import Containernet
from mininet.node import Docker
from mininet.cli import CLI
from mininet.log import setLogLevel, info
from mininet.link import TCLink, Link
 
def topology():
 
    "Create a network with some docker containers acting as hosts."
    net = Containernet()
 
    info('*** Adding hosts\n')
    h1 = net.addHost('h1', ip='192.168.0.1/24')
    r1 = net.addHost('r1', ip='192.168.0.254/24')
    d1 = net.addDocker('d1', ip='10.0.0.1/24', dimage="ubuntu:1.0")
 
    info('*** Creating links\n')
    net.addLink(h1, r1)
    net.addLink(r1, d1)
   
    info('*** Starting network\n')
    net.start()
    d1.cmd("/etc/init.d/ssh start")
    r1.cmd("ifconfig r1-eth1 0")
    r1.cmd("ip addr add 10.0.0.2/24 brd + dev r1-eth1")
    r1.cmd("echo 1 > /proc/sys/net/ipv4/ip_forward")
    r1.cmd("iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o r1-eth1 -j MASQUERADE")
    h1.cmd("ip route add default via 192.168.0.254")
    h1.cmd("python -m SimpleHTTPServer 80 &") 
 
    info('*** Running CLI\n')
    CLI(net)
 
    info('*** Stopping network')
    net.stop()
 
if __name__ == '__main__':
    setLogLevel('info')
    topology()

```
執行檔案
```
# python3 lab3.py
 > xterm h1 
```

開啟終端機至d1，開啟網頁伺服器
```
# docker exec -it mn.d1 bash
 /# ping 192.168.0.1
    //ping不到
 /# curl 192.168.0.1
     //抓不到
```

在h1建立加密登入
```
# ssh -Nf -R 10.0.0.1:5555:192.168.0.1:80 root@10.0.0.1
  passwd：ubuntu
# python -m SimpleHTTPServer 80
```

d1
```
# curl 127.0.0.1:5555
```
![image](https://github.com/zixxizxx/Liux-note/blob/main/110-2%20Mininet/image/20220425/0425-2.jpg)







